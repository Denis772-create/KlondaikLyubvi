@page "/love"
@inject HttpClient Http
@inject IJSRuntime JS
@using Microsoft.JSInterop

@implements IAsyncDisposable
@code {
    class LoveNoteDto
    {
        public int Id { get; set; }
        public string Text { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public int UserId { get; set; }
        public string? UserDisplayName { get; set; }
    }
    List<LoveNoteDto> Notes = new();
    string? Text, Error, EditText;
    int? EditId = null;
    int UserId = 0;
    string? UserName;
    bool showEmojiPicker = false;
    string activeEmojiCategory = "Ğ›ÑĞ±Ğ¾Ğ²ÑŒ";
    Dictionary<string, string[]> EmojiCategories = new()
    {
        ["Ğ›ÑĞ±Ğ¾Ğ²ÑŒ"] = new [] { "ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜»","ğŸ’–","ğŸ’—","ğŸ’“","ğŸ’","ğŸ’•","ğŸ’˜","ğŸ’","ğŸ’Ÿ","ğŸ’‹","ğŸ’Œ","ğŸŒ¹","ğŸŒ¸","ğŸ«¶","ğŸ¤","ğŸ©·","ğŸ«¦" },
        ["Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¸"] = new [] { "ğŸ˜Š","ğŸ˜‡","ğŸ˜Œ","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜…","ğŸ˜‰","ğŸ¤—","ğŸ™ˆ","ğŸ¥¹","ğŸ˜­","ğŸ¤”","ğŸ¤­","ğŸ¤©","ğŸ¥³" },
        ["Ğ–ĞµÑÑ‚Ñ‹"] = new [] { "ğŸ‘","ğŸ‘","ğŸ‘","ğŸ¤","ğŸ™","ğŸ‘Œ","âœŒï¸","ğŸ¤Ÿ","ğŸ«¶","ğŸ‘Š","ğŸ¤²","ğŸ«¶ğŸ»" },
        ["Ğ•Ğ´Ğ°"] = new [] { "ğŸ“","ğŸ«","ğŸ°","ğŸ©","ğŸª","ğŸ§","ğŸ¯","ğŸ","ğŸ’","ğŸ‡","ğŸ¥","ğŸ¥","â˜•","ğŸ·" },
        ["Ğ Ğ°Ğ·Ğ½Ğ¾Ğµ"] = new [] { "ğŸ","ğŸ‰","âœ¨","ğŸ”¥","ğŸŒ™","â­","â˜€ï¸","ğŸ›","ğŸ¥","ğŸµ","ğŸ“¸","ğŸ–ï¸" }
    };
    void ToggleEmojiPicker()
    {
        showEmojiPicker = !showEmojiPicker;
        if (showEmojiPicker)
        {
            _selfRef ??= DotNetObjectReference.Create(this);
            JS.InvokeVoidAsync("registerClickOutsideById", "emoji-picker", _selfRef);
        }
        else
        {
            JS.InvokeVoidAsync("unregisterClickOutsideById", "emoji-picker");
        }
    }
    void InsertEmoji(string emoji)
    {
        Text += emoji;
        // ĞºĞ°Ğº Ğ² Telegram: Ğ¿Ğ¸ĞºĞµÑ€ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸
    }
    DotNetObjectReference<LoveWall>? _selfRef;
    protected override async Task OnInitializedAsync()
    {
        Notes = await Http.GetFromJsonAsync<List<LoveNoteDto>>("/api/lovenotes") ?? new();
        UserId = await GetUserId();
    }
    // Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ¿Ğ¸ĞºĞµÑ€Ğ°
    [JSInvokable]
    public void CloseEmojiPicker()
    {
        if (showEmojiPicker)
        {
            showEmojiPicker = false;
            StateHasChanged();
        }
    }
    public ValueTask DisposeAsync()
    {
        _selfRef?.Dispose();
        return ValueTask.CompletedTask;
    }
    async Task<int> GetUserId()
    {
        var userIdStr = await JS.InvokeAsync<string>("blazorGetCookie", "userId");
        return int.TryParse(userIdStr, out var id) ? id : 0;
    }
    async Task AddNote()
    {
        Error = null;
        var resp = await Http.PostAsJsonAsync("/api/lovenotes", new LoveNoteDto { Text = Text ?? "", UserId = UserId });
        if (resp.IsSuccessStatusCode)
        {
            var note = await resp.Content.ReadFromJsonAsync<LoveNoteDto>();
            if (note != null) Notes.Insert(0, note);
            Text = "";
        }
        else
        {
            Error = "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ";
        }
    }
    void StartEdit(LoveNoteDto note)
    {
        EditId = note.Id;
        EditText = note.Text;
    }
    async Task SaveEdit(LoveNoteDto note)
    {
        note.Text = EditText ?? note.Text;
        var resp = await Http.PutAsJsonAsync($"/api/lovenotes/{note.Id}", note);
        if (resp.IsSuccessStatusCode)
        {
            EditId = null;
            EditText = null;
        }
        else
        {
            Error = "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ";
        }
    }
    async Task DeleteNote(LoveNoteDto note)
    {
        var resp = await Http.DeleteAsync($"/api/lovenotes/{note.Id}");
        if (resp.IsSuccessStatusCode)
        {
            Notes.Remove(note);
        }
        else
        {
            Error = "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ";
        }
    }
}

<div class="bg-gradient-to-br from-rose-50 to-pink-100 min-h-screen py-6 px-2 sm:py-10 sm:px-4 font-sans">
    <div class="max-w-3xl mx-auto bg-white/80 backdrop-blur-md rounded-2xl shadow-xl p-4 sm:p-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-pink-600 mb-6 text-center flex items-center justify-center gap-2">
            <span class="inline-block text-3xl sm:text-4xl">ğŸ“</span> Ğ¯ Ñ‚ĞµĞ±Ñ Ğ»ÑĞ±Ğ»Ñ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾â€¦
        </h1>
        <p class="text-center text-gray-600 mb-8 text-xs sm:text-sm">ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ñƒ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ, Ğ½Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ»ÑĞ±Ğ²Ğ¸ ğŸ’–</p>
        <div class="flex flex-wrap gap-2 mb-6 relative">
            <input @bind="Text" class="flex-1 rounded-xl border-pink-200 px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ..." />
            <button type="button" @onclick="ToggleEmojiPicker" class="px-2 text-xl sm:text-2xl">ğŸ˜Š</button>
            <button class="bg-pink-500 hover:bg-pink-600 text-white px-4 sm:px-6 py-2 rounded-xl font-semibold text-sm sm:text-base transition" @onclick="AddNote">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
            @if (showEmojiPicker)
            {
                <div id="emoji-picker" class="absolute left-0 top-full mt-2 z-20 w-[min(100%,360px)] bg-white rounded-2xl shadow-2xl p-2 animate-fade-in border border-pink-100 select-none" @onmousedown:stopPropagation>
                    <div class="flex gap-1 mb-2 overflow-x-auto">
                        @foreach (var cat in EmojiCategories.Keys)
                        {
                            var isActive = cat == activeEmojiCategory;
                            <button type="button" class="@(isActive ? "px-3 py-1 rounded-full text-sm whitespace-nowrap bg-pink-500 text-white" : "px-3 py-1 rounded-full text-sm whitespace-nowrap bg-pink-50 text-pink-600 hover:bg-pink-100")" @onclick="() => activeEmojiCategory = cat">@cat</button>
                        }
                    </div>
                    <div class="grid grid-cols-6 sm:grid-cols-8 gap-1 max-h-56 overflow-y-auto">
                        @foreach (var emoji in EmojiCategories[activeEmojiCategory])
                        {
                            <button type="button" class="text-lg sm:text-xl hover:scale-125 transition" @onclick="() => InsertEmoji(emoji)">@emoji</button>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="space-y-5">
           @foreach (var note in Notes)
{
    var isDenis = note.UserId == 1; // 1 â€” Ğ”ĞµĞ½Ğ¸Ñ, 2 â€” Ğ›Ğ¸Ğ·Ğ°
    var emoji = isDenis ? "ğŸ§”" : "ğŸ‘©";
    var bg = isDenis ? "linear-gradient(to right, #e0f2fe, #bae6fd)" : "linear-gradient(to right, #fce7f3, #fbcfe8)";
    var color = isDenis ? "#2563eb" : "#be185d";
    <div class="rounded-xl shadow-lg p-4 sm:p-5 flex flex-col gap-2 transition"
         style="background: @bg">
        <div class="flex items-center gap-2 flex-wrap">
            <span class="text-xl sm:text-2xl">@emoji</span>
            @if (EditId == note.Id)
            {
                <div class="flex-1 min-w-0 flex flex-col sm:flex-row sm:items-center gap-2">
                    <input class="w-full min-w-0 rounded-lg border px-3 py-2 text-sm sm:text-base" @bind="EditText" />
                    <div class="flex items-center gap-3">
                        <button class="text-sm text-green-600 hover:text-green-700 font-semibold" @onclick="() => SaveEdit(note)">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
                        <button class="text-sm text-gray-500 hover:text-gray-700" @onclick="() => { EditId = null; EditText = null; }">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
                    </div>
                </div>
            }
            else
            {
                <div class="text-base sm:text-lg font-semibold flex-1 break-words" style="color:@color">@note.Text</div>
            }
            @if (note.UserId == UserId && EditId != note.Id)
            {
                <button class="text-xs text-pink-400 hover:text-pink-600" title="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" @onclick="() => StartEdit(note)">âœï¸</button>
                <button class="text-xs text-red-400 hover:text-red-600" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ" @onclick="() => DeleteNote(note)">ğŸ—‘</button>
            }
        </div>
        <div class="text-xs sm:text-sm text-gray-400">@note.Date.ToLocalTime().ToString("dd.MM.yyyy")</div>
    </div>
}
        </div>
        @if (!string.IsNullOrEmpty(Error))
        {
            <div class="text-red-500 mt-4">@Error</div>
        }
    </div>
</div>

<style>
.animate-fade-in { animation: fade-in 0.15s cubic-bezier(.4,0,.2,1) both; }
@@keyframes fade-in {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>